# Scripts or tools used in the analysis

## Introduction
The repository deposits all customized R/Python/BASH code used for the analysis by study *Zhang et. al. 2023 (DOI: *TBA*) for the purpose of reproduction.

## Table of tools/packages used in the analysis

| Tool name | Version | Comments |
| :-------: | :-----: | :------: |
| PLINK     |         |          |
| BCFtools  |         |          |
| limix_qtl |         |          |
| Seurat    |         |          |
| Python    |         | Programming language |
| R         |         | Programming language |

## `Singularity` container to reproduce the analysis

To replicate the whole analysis, we packed the packages/tools used in the analysis into a `Singularity` container.
The configure file of the container is available in `singularity/sceQTL_300bcg.def`.
A precompiled `Singularity` container is available in on [Zenodo](https://doi.org/10.5281/zenodo.xxx).

## Statistical analysis
The statistical analyses were performed by in-house R/Python script or published tools/packages.
The codes used to performed each analysis are listed and briefly introduced as the following.

### Single-cell RNA-seq analysis and cell type identification
1. Demultiplexing by `souporcell`
2. Single-cell analysis by `Seurat`
3. Cell type identification by `?`

### Identification of single-cell expression quantitative traits loci (sceQTL)
The eQTL of each cell type or conditions were estimated using a linear mixed model which is implemented in [`limix_qtl`](https://github.com/single-cell-genetics/limix_qtl).
An author recommended pipeline was implemented in `snakemake/300bcg_limix_qtl.smk`.

### Estimation of shared signals
We used MASH (MASHR) to estimate the shared eQTL signals between each pair of eQTL summary statistics.
These steps are available by `r/mashr.r`.

### Construction of reference genotype panel
To speed up the calculation of harmonization step, we prepared a reference panel using genetic variants from 1000 genome project.
The generated reference panel was also used to estimate enrichement of the identified QTL SNPs in epigenomic annotations.
The detailed steps is recorded in `bash/prepare_reference.sh`

### Harmonization of genetic variants
`r/harmonization.r`

### Summary based Mendelian randomization (SMR) analysis
`bash/smr.sh`

### Colocalization analysis
`r/coloc.r`

### Enrichement of identified QTL SNPs in epigenomic annotations
We obtained cell-type-specific ATAC-seq peaks from three cell types, namely monocytes, CD8T, and NK cells, sorted from PBMC samples at d0 ("V1") in quantification*.csv.gz files.
`bash/enrich.sh` and `r/enrich.r`.

## Publicly available data and 

### Table of publicly available GWAS summary statistics
| Trait  | TraitCategory | IEUOpenGWAS_ID | StudyPMID |
| :----: | :-------: | :-------: | :-----: |
| Obesity | | | |

### Table of reference data

| Reference name   | Version          | Availability | Comments |
| :--------------: | :--------------: | :----------: | :------: |
| Human genome     | GRCh38           |              |          |
| Genetic variants | GRCh38/build xxx |              | |

<!-- ### Identification of co-expression modules
  We used weighted gene co-expression network analysis (WGCNA) to detect co-expression modules for each transcriptomic profiles of four identified cell types.
  For more details about the analysis check R code at `r/wgcna.r`
-->


## Misc

SingleR reference

| Database                            | Species | Comments                                                                                                  |
| :---------------------------------: | :-----: | :-------------------------------------------------------------------------------------------------------: |
| Monaco immnune data                 | Human   | RNA-Seq profiling on 29 immune cell types consituting PBMCs sorted from 4 Singaporean-Chinese individuals |
| Human Primary Cell Atlas            | Human   | Microarray datasets derived from human primary cells                                                      |
| Blueprint / ENCODE                  | Human   | Bulk RNA-seq data for pure stroma and immune cells generated by Blueprint                                 |
| Database of Immnune Cell Expression | Human   | Bulk RNA-seq samples of sorted human immune cell populations                                              |

## Check list
Scripts used to generate single-cell eQTL from 300BCG cohort.
  - [x] ./bash/estimate_independent_gwas_loci.sh
  - [x] ./bash/prepare_kinship_matrix.sh
  - [x] ./bash/smr.sh
  - [x] ./py3/fetch_snp_info.py
  - [x] ./py3/plot_asoc_rc.py
  - [x] ./r/PieDonut.R
  - [ ] ./r/enrich.r
  - [x] ./r/harmonization.r
  - [ ] ./r/mashr.r
  - [ ] ./r/plot_main_figures.r
  - [ ] ./r/prepare_inputs_limix_eqtl.r
  - [ ] ./r/replication.r
  - [ ] ./r/trackplot.r
  - [x] ./snakemake/300bcg_limix_qtl.smk
